<header>
  <h1>GitHub Actions käytännössä</h1>
  <p>
    Tässä osiossa tehdään pieni yksinkertainen GitHub Action workflow. Lisäksi tarkastellaan mistä
    Actionsiin liittyvät asetukset ja muut tiedot löytyvät GitHubissa. Tämän osion kannalta ei ole
    tarkoituksen mukaista käydä läpi workflow kirjoittamista kohtakohdalta. Voit ladata oppaassa
    käytetyn YAML-tiedoston tästä:
    <a href="/advanced/automation/example-workflow/example.yaml" download>example.yaml</a>.
    Tiedostossa on pyritty kommentoimaan tarkasti mitä eri vaiheissa tapahtuu. Myös edellisellä
    sivulla on avattu tarkemmin workflow tiedoston sisältöä ja rakennetta.
  </p>
  <p>
    Tässä osiossa käytetään samaa repositoriota kuin aikaisemmissakin ohjeissa. Työnkulku
    tiedostossa example.yaml automatisoi jo aikaisemminkin oppaassa paljon käytetyn README.md
    tiedoston muokkaamisen. Tiedostoon tallennetaan versionumero, jota kasvatetaan jokaisen commitin
    yhteydessä yhdellä. Lisäksi haetaan Gitin lokitiedostosta viimeisimmän commitin tietoja. jotka
    kirjataan README-tiedostoon ns. tekijätiedoiksi. Lopuksi tehdään automaattinen Commit, joka
    tallentaa README tiedoston muutokset repositorion päähaaraan.
  </p>
</header>
<section>
  <h2>GitHub Actions workflown käyttöönotto</h2>
  <ol>
    <li>
      <h6
        >Muuta GitHub Actionsin asetuksia, jotta se voi tehdä muutoksia repositorion
        tiedostoihin</h6
      >
      <ul>
        <li>
          Mene selaimella GitHubiin, valitse repositorio ja mene sen <strong>asetuksiin</strong>
        </li>
        <li>Valitse sivuvalikosta <strong>Actionsin</strong> alta <strong>General</strong></li>
        <li
          >Varmista, että <strong>Allow all actions and reusable workflows</strong> on valittuna</li
        >
      </ul>
      <figure>
        <img
          class="wide-image"
          src="../../assets/images/advanced/actions/actions-1.webp"
          alt="Actionsin asetukset GitHubissa" />
        <figcaption>GitHub Actionsin asetuksien muuttaminen.</figcaption>
      </figure>
      <ul>
        <li>Scrollaa asetussivua alaspäin kohtaan <strong>Workflow permissions</strong></li>
        <li>
          Anna Actionsille lupa muokata tiedostoja valitsemalla
          <strong>Read and write permissions</strong>
        </li>
        <li>Tallenna valinta painamalla <strong>Save</strong> nappia</li>
      </ul>
      <figure>
        <img
          class="wide-image"
          src="../../assets/images/advanced/actions/actions-2.webp"
          alt="Github Actions Workflow permissions asetukset" />
        <figcaption>
          Luvan antaminen GitHub Actionsille lukea ja kirjoittaa repositorion tiedostoihin.
        </figcaption>
      </figure>

      <div class="note-box">
        <ul>
          <strong> Huomio: repository-oikeudet</strong>
          <li class="warning"
            >Salli <em>Read &amp; write</em> -oikeudet GitHub Actionsille vain, jos työnkulku
            oikeasti tarvitsee tehdä muutoksia repositorioon (commit, push, tagit).
            Kirjoitusoikeudet antavat workflow'lle vallan muokata tiedostoja — väärin konfiguroituna
            tämä voi johtaa ei-toivottuihin muutoksiin tai turvallisuusriskeihin.</li
          >
          <li>
            Lisää tietoa asetuksista
            <a
              target="_blank"
              rel="noopener noreferrer"
              href="https://docs.github.com/en/repositories/managing-your-repositorys-settings-and-features/enabling-features-for-your-repository/managing-github-actions-settings-for-a-repository"
              >täältä</a
            >
          </li>
        </ul>
      </div>
    </li>
    <li>
      <h6>Workflow-tiedoston lisääminen repositorioon</h6>
      <ul>
        <li>Tee repositorion juureen kansio ja nimeä se: <strong>.github</strong></li>
        <li>Tee .github kansion sisään uusi kansio ja nimeä se: <strong>workflows</strong></li>
      </ul>
      <figure>
        <img
          class="wide-image"
          src="../../assets/images/advanced/actions/actions-3.webp"
          alt="Tarvittavien kansioiden lisääminen repositorioon." />
        <figcaption>.github ja workflows kansioiden lisääminen repositorion juureen.</figcaption>
      </figure>
      <ul>
        <li>
          Lisää <strong>example.yaml</strong> workflow-tiedosto <strong>workflows</strong> kansioon
        </li>
        <li>
          Näin Actions löytää työkulun ja osaa käynnistää sen, kun sen laukaiseva toiminto
          suoritetaan GitHub repositoriossa
        </li>
      </ul>
      <figure>
        <img
          class="wide-image"
          src="../../assets/images/advanced/actions/actions-4.webp"
          alt="workflow-tiedoston lisääminen" />
        <figcaption>example.yaml workflow-tiedosto lisätty workflows kansioon.</figcaption>
      </figure>
    </li>
    <li>
      <h6>Vie lisätty workflow etärepositorion päähaaraan.</h6>
      <ul>
        <li>
          Tämän ohjeen kannalta ei ole väliä teetkö ja commitoitko muutoksen suoraan päähaaraan ja
          viet ne etärepositorioon esim. komennolla:
          <code>git push origin main</code>
        </li>
        <li>
          Vai käytätkö muutoksille omaa haaraa ja yhdistät ne mergen tai pull requestin avulla.
        </li>
      </ul>
    </li>
    <li>
      <h6>Workflown tarkastelu GitHubissa.</h6>
      <ul>
        <li><strong>Actions</strong> välilehdellä pääsee tarkastelemaan työnkulkuja</li>
        <ul>
          <li><strong>Vihreä:</strong> Päättynyt ja onnistunut workflow</li>
          <li><strong>Punainen:</strong> Virheeseen päättynyt workflow</li>
          <li><strong>Keltainen:</strong> Parhaillaan ajettava workflow</li>
        </ul>

        <li>
          Työnkulun lokia ja pidemmissä työnkuluissa sen suoritusta pääsee tarkastelemaan
          klikkaamalla sen aloittaneen commitin <strong>viestiä</strong>
        </li>
      </ul>
      <figure>
        <img
          class="wide-image"
          src="../../assets/images/advanced/actions/actions-5.webp"
          alt="Tiedostot GitHib repositoriossa" />
        <figcaption>Valitun git-haaran varmistaminen ja tiedoston valitseminen.</figcaption>
      </figure>

      <div
        class="accordion"
        data-include="../../accordion-element/accordion.html"
        data-title="Workflow repositorion etusivulla (code-välilehti)">
        <div class="contentToAccordion">
          <p>
            Myös repositorion code-välilehdellä näytetään workflown tila samoilla väreillä kuin
            actions-välilehdellä.
          </p>
          <figure>
            <img
              class="wide-image"
              src="../../assets/images/advanced/actions/actions-5.2.webp"
              alt="Workflow repositorion etusivulla (code-välilehti)" />
            <figcaption
              >Workflow: tilan näkyminen repositorion etusivulla (code-välilehti).</figcaption
            >
          </figure>
        </div>
      </div>

      <ul>
        <li>Avaa tarkempi loki klikkaamalla työn (job) <strong>nimeä</strong></li>
      </ul>
      <figure>
        <img
          class="wide-image"
          src="../../assets/images/advanced/actions/actions-6.webp"
          alt="Actions lokin avaaminen" />
        <figcaption>Avaa loki klikkaamalla työn nimeä.</figcaption>
      </figure>
    </li>
    <li>
      <h6>Lokin tarkastelu.</h6>
      <ul>
        <li>
          Erityisesti epäonnistuneiden työnkulkujen lokin tarkastelu on tärkeää, jotta päästään
          selvyyteen mistä epäonnistuminen johtui
        </li>
        <li>Lokissa epäonnistunut askel näkyy punaisella x-symbolilla</li>
        <li>
          Klikkaamalla askeleen nimen vieressä olevaa nuolta saa avattua tarkemmat tiedot askeleesta
          ja virheestä (mikäli ne eivät ole jo näkyvissä)
        </li>
        <li>
          Tässä tapauksessa yritettiin tehdä muutoksia tiedostoon <strong>READ.md</strong>. Koska
          tiedostoa ei ollut repositoriossa, työnkulku loi uuden tiedoston ja sen
          <strong>commitointi epäonnistui</strong> ja <strong>pysäytti workflown</strong>.
        </li>
        <li>Varsinainen virhe voi siis olla muuallakin kuin työn pysäyttäneessä askeleessa.</li>
      </ul>
      <figure>
        <img
          class="wide-image"
          src="../../assets/images/advanced/actions/actions-7.webp"
          alt="Actions workflown lokin tarkastelu" />
        <figcaption>Lokin ja työnkulun pysäyttäneen virheen tarkastelu.</figcaption>
      </figure>
    </li>
    <li>
      <h6>Workflown README-tiedostoon tekemät muutokset repositoriossa.</h6>
      <ul>
        <li>Onnistuneesti suoritettuna workflow lisäsi README-tiedostoon versio-osion.</li>
        <li>Osiossa on nyt näkyvillä "versionumero" sekä commitin ja sen tekijän tietoja. </li>
      </ul>
      <figure>
        <img
          class="wide-image"
          src="../../assets/images/advanced/actions/actions-8.webp"
          alt="Workflown tekemien muutoksien tarkastelu repositoriossa" />
        <figcaption>Näin workflown tekemät muutokset näkyvät README-tiedostossa.</figcaption>
      </figure>

      <ul>
        <li>Tiedot myös päivittyvät sen mukaan kuka commitin tekee.</li>
      </ul>

      <figure>
        <img
          class="wide-image"
          src="../../assets/images/advanced/actions/actions-9.webp"
          alt="README-tiedoston tietojen päivittyminen" />
        <figcaption>Tiedot päivittyvät README-tiedostossa</figcaption>
      </figure>

      <ul>
        <li>
          Mikäli ollaan tarkkoja, niin esim. commitin hash ei ole viimeisimmän commitin tunniste.
          Sillä viimeisin commit on itseasiassa workflown tekemä muutos README-tiedostoon.
        </li>
      </ul>

      <figure>
        <img
          class="wide-image"
          src="../../assets/images/advanced/actions/actions-10.webp"
          alt="Commithistorian tarkastelu" />
        <figcaption
          >Commithistoriassa näkyy niin käyttäjän kuin workflown tekemä commit.</figcaption
        >
      </figure>
    </li>
    <li>
      <h6>Actions käytön seuranta.</h6>
      <ul>
        <li>
          Actionsin tilastoja käytöstä voi tarkastella klikkaamalla
          <strong>Actions</strong>-välilehdellä <strong>Usage metrics</strong> nappia
        </li>
      </ul>
      <figure>
        <img
          class="wide-image"
          src="../../assets/images/advanced/actions/actions-11.webp"
          alt="Actionsin käyttötilaston avaaminen" />
        <figcaption>Käyttötilastoon pääsee klikkaamalla Usage metrics nappia.</figcaption>
      </figure>
      <ul>
        <li>
          Näin avautuu <strong>Insights</strong>-välilehden osio
          <strong>Actions usage metrics</strong>
        </li>
        <li>
          Näkymään siis pääsee myös menemällä <strong>Insights</strong>-välilehdelle ja klikkaamalla
          sivupalkista
        </li>
        <li>
          Näkymän yläosassa näkyy repositorion kaikkien
          <strong>työnkulkujen suorittamiseen käytetty aika</strong>
        </li>
        <li>
          Listasta voi tarkastella tarkemmin yksittäisen työnkulun tai tietyn työn käyttämää aikaa
        </li>
      </ul>
      <figure>
        <img
          class="wide-image"
          src="../../assets/images/advanced/actions/actions-12.webp"
          alt="Actionsin käyttötilasto näkymä" />
        <figcaption>Käyttötilaston tarkastelu.</figcaption>
      </figure>
      <ul>
        <li>
          Tilin Actionsin käyttötilastoa kaikkien repositorioiden osalta voi tarkastella menemällä
          <strong>tilin asetuksiin</strong> ja valitsemalla sivuvalikosta Billin and licensingin
          alta <strong>Overview</strong>
        </li>
        <li>
          Metered usage osiossa on näkyvillä
          <strong>paljonko käyttöaikaa on kokonaisuudessa ja paljonko sitä on käytetty</strong>
        </li>
      </ul>
      <figure>
        <img
          class="wide-image"
          src="../../assets/images/advanced/actions/actions-13.webp"
          alt="Tilin asetuksien billing and licensing osion päänäkymä" />
        <figcaption>Billing and licensing osion tarkastelu.</figcaption>
      </figure>
      <div class="note-box">
        <ul>
          <li>
            <strong>Huomio: Billing &amp; Licensing -näkymä</strong><br />
            GitHubissa näkyvä <em>Billing &amp; Licensing</em> -sivu voi näyttää dollareina hintoja
            toimintojen käytöstä, mutta niistä ei tarvitse huolestua peruskäytössä. Ilmaisella
            GitHub-tilillä saat käyttöösi <strong>2 000 minuuttia/kk Actions-ajoa</strong> ja
            <strong>500 MB tallennustilaa</strong> ilman kustannuksia.
          </li>
          <li>
            Jos et ole lisännyt maksutietoja ja ylität ilmaiset käyttörajat, GitHub ei veloita
            mitään. Actionsin ajot kuitenkin keskeytyvät automaattisesti siihen asti kunnes uusi
            kuukausi alkaa ja käyttöraja nollautuu.
          </li>
          <li> Näkymä näyttää siis vain millaisia kustannuksia tulisi ilman ilmaista käyttöä. </li>
        </ul>
      </div>
    </li>
  </ol>
</section>
