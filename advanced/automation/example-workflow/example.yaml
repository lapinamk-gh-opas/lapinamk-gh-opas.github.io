# Ty√∂nkulun (workflow) nimi (vapaasti nimett√§viss√§).
name: README.md tiedoston tietojen p√§ivitys

# Milloin ty√∂nkulku suoritetaan.
# T√§ss√§ tapauksessa, kun tehd√§√§n push main haaraan.
on:
  push:
    branches:
      - main

# Ty√∂kulun aikana suoritettavat teht√§v√§n
jobs:
  # Teht√§v√§n nimi (vapaasti nimett√§viss√§)
  update-readme:
    # Mill√§ k√§ytt√∂j√§rjestelm√§ll√§ (runner) suoritetaan
    runs-on: ubuntu-latest

    # Teht√§v√§n askeleet
    steps:
      # Askeleen nimi (vapaasti nimett√§viss√§), joka n√§kyy workflown lokitiedoissa
      - name: Checkout
        # Jos k√§ytet√§√§n valmiita actioneja sen suoritus nimet√§√§n: uses: julkaisija/paketin-nimi.
        # Esim. uses: actions/checkout@v4, jolla ladataan repositorion sis√§lt√∂ workflow‚Äôn suoritusymp√§rist√∂√∂n,
        # jotta muut stepit voivat k√§sitell√§ tiedostoja.
        uses: actions/checkout@v4

      # Askeleen nimi (vapaasti nimett√§viss√§), joka n√§kyy workflown lokitiedoissa
      - name: Hae commitin tiedot
        # id:n avulla t√§m√§ askel (step) tunnistetaan my√∂hemmin workflowssa
        # ja sen tietoihin p√§√§st√§√§n k√§siksi sen kautta esim. ${{ steps.author.outputs.name }}
        id: author
        # Jos k√§ytet√§√§n komentorivikomentoja (scriptej√§) sen suoritus nimet√§√§n: run: komento.
        # pystyviivan | avulla voidaan komennot jakaa useammalle riville.
        # esim. t√§ss√§ tallennetaan tietoja Gitin lokitiedoista "muuttujiin" name, email, message, date ja hash
        run: |
          echo "name=$(git log -1 --pretty=format:'%an')" >> $GITHUB_OUTPUT
          echo "email=$(git log -1 --pretty=format:'%ae')" >> $GITHUB_OUTPUT
          echo "message=$(git log -1 --pretty=format:'%s')" >> $GITHUB_OUTPUT
          echo "date=$(git log -1 --pretty=format:'%cd')" >> $GITHUB_OUTPUT
          echo "hash=$(git log -1 --pretty=format:'%h')" >> $GITHUB_OUTPUT

      # P√§ivitet√§√§n README.md-tiedostoon sovelluksen versio sek√§ commitin tiedot
      - name: P√§ivit√§ README
        run: |
          FILE="README.md"
          # --- Workflown lokiin merkint√§ p√§ivityksest√§ ---
          echo "üîÑ P√§ivitet√§√§n $FILE..."

          # --- P√§ivitet√§√§n versio ---
          if grep -q '^Sovelluksen versio:' "$FILE"; then
            # Haetaan nykyinen versio ja kasvatetaan sit√§ yhdell√§
            VERSION=$(grep -Eo '^Sovelluksen versio: *[0-9]+' "$FILE" | grep -Eo '[0-9]+')
            NEW_VERSION=$((VERSION + 1))
            sed -i'' -e "s/^Sovelluksen versio:.*/Sovelluksen versio: ${NEW_VERSION}/" "$FILE"
          else
            # --- Jos versiota ei viel√§ ole, luodaan se ---
            echo "## üì¨ Versio" >> "$FILE"
            echo "" >> "$FILE"
            echo "Sovelluksen versio: 1" >> "$FILE"
            echo "" >> "$FILE"
            NEW_VERSION=1
          fi

          # --- Poistetaan vanhat commitin tekij√§n tiedot ---
          sed -i'' -e '/^Viimeisin commit/d' "$FILE"
          sed -i'' -e '/^- Tekij√§:/d' "$FILE"
          sed -i'' -e '/^- Email:/d' "$FILE"
          sed -i'' -e '/^- Pvm:/d' "$FILE"

          # --- Lis√§t√§√§n uudet tiedot ---
          echo "Viimeisin commit (#${{ steps.author.outputs.hash }})" >> "$FILE"
          echo "- Tekij√§: ${{ steps.author.outputs.name }}" >> "$FILE"
          echo "- Email: ${{ steps.author.outputs.email }}" >> "$FILE"
          echo "- Pvm: ${{ steps.author.outputs.date }}" >> "$FILE"

          # --- Workflown lokiin merkint√§ p√§ivityksen onnistumisesta ---
          echo "‚úÖ README p√§ivitetty versiolle ${NEW_VERSION}"

      # Commitoidaan README.md tiedoston muutokset ja vied√§√§n ne p√§√§haaraan
      - name: Commit ja push
        run: |
          git config user.name ${{ steps.author.outputs.name }}
          git config user.email ${{ steps.author.outputs.email }}
          git add README.md
          git commit -m "${{ steps.author.outputs.message }}"
          git push origin main
